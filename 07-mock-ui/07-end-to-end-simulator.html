<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlag - End-to-End System Flow Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .flow-node {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .flow-node:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .flow-node.active {
            animation: pulse-active 1.5s infinite;
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }
        @keyframes pulse-active {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .flow-arrow {
            stroke-width: 2;
            stroke: #6b7280;
            fill: none;
            marker-end: url(#arrowhead);
        }
        .flow-arrow.active {
            stroke: #10b981;
            stroke-width: 3;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }
        .log-entry {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.completed {
            background-color: #10b981;
            color: white;
        }
        .step-indicator.active {
            background-color: #3b82f6;
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
        .highlight { color: #22c55e; font-weight: bold; }
        .comment { color: #94a3b8; }
        .keyword { color: #60a5fa; }
        .string { color: #fbbf24; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-[#002c5f] text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-project-diagram text-2xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">End-to-End System Flow Simulator</h1>
                        <p class="text-sm text-blue-200">FleetFlag ì „ì²´ ì‹œìŠ¤í…œ ë™ì‘ ì‹œë®¬ë ˆì´ì…˜ (Feature ìƒì„± â†’ ë°°í¬ â†’ ì°¨ëŸ‰ í‰ê°€ â†’ ë¶„ì„)</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="startSimulation" class="bg-green-600 px-6 py-3 rounded-lg hover:bg-green-700 font-bold">
                        <i class="fas fa-play mr-2"></i>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                    </button>
                    <button id="resetSimulation" class="bg-gray-600 px-6 py-3 rounded-lg hover:bg-gray-700 font-bold">
                        <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Scenario Selector -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-list-ul mr-2 text-blue-600"></i>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
            </h2>
            <div class="grid grid-cols-3 gap-4">
                <label class="scenario-card border-2 border-blue-600 bg-blue-50 rounded-lg p-4 cursor-pointer">
                    <input type="radio" name="scenario" value="feature-creation" checked class="mb-2">
                    <div class="font-bold text-gray-900">ğŸ“ Feature ìƒì„± ë° ë°°í¬</div>
                    <div class="text-xs text-gray-600 mt-2">
                        ìƒˆ Feature Flagë¥¼ ìƒì„±í•˜ê³  ë‹¨ê³„ë³„ Canary ë°°í¬í•˜ëŠ” ì „ì²´ íë¦„
                    </div>
                </label>
                <label class="scenario-card border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:border-gray-400">
                    <input type="radio" name="scenario" value="kill-switch" class="mb-2">
                    <div class="font-bold text-gray-900">ğŸ”´ Kill Switch ê¸´ê¸‰ ë°œë™</div>
                    <div class="text-xs text-gray-600 mt-2">
                        ì•ˆì „ ì´ìŠˆ ë°œê²¬ ì‹œ 3ì‹œê°„ ë‚´ ì „ ì°¨ëŸ‰ ê¸´ê¸‰ ì°¨ë‹¨
                    </div>
                </label>
                <label class="scenario-card border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:border-gray-400">
                    <input type="radio" name="scenario" value="ab-test" class="mb-2">
                    <div class="font-bold text-gray-900">ğŸ§ª A/B í…ŒìŠ¤íŠ¸ ì‹¤í–‰</div>
                    <div class="text-xs text-gray-600 mt-2">
                        ë‘ ì•Œê³ ë¦¬ì¦˜ì„ ë¹„êµí•˜ê³  í†µê³„ì  ìœ ì˜ì„± ê²€ì¦
                    </div>
                </label>
            </div>
        </div>

        <!-- Main Flow Diagram -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-6">
                <i class="fas fa-sitemap mr-2 text-purple-600"></i>ì‹œìŠ¤í…œ íë¦„ë„
            </h2>
            
            <div class="relative" style="height: 600px;">
                <!-- SVG for Arrows -->
                <svg class="absolute inset-0 w-full h-full" style="z-index: 0;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#6b7280" />
                        </marker>
                        <marker id="arrowhead-active" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#10b981" />
                        </marker>
                    </defs>
                    
                    <!-- Admin â†’ API Server -->
                    <path id="arrow-1" class="flow-arrow" d="M 250 80 L 250 140" stroke-dasharray="5,5"/>
                    
                    <!-- API Server â†’ Flipt -->
                    <path id="arrow-2" class="flow-arrow" d="M 350 180 L 450 180" stroke-dasharray="5,5"/>
                    
                    <!-- Flipt â†’ PostgreSQL -->
                    <path id="arrow-3" class="flow-arrow" d="M 550 220 L 550 280" stroke-dasharray="5,5"/>
                    
                    <!-- PostgreSQL â†’ Redis -->
                    <path id="arrow-4" class="flow-arrow" d="M 650 320 L 750 320" stroke-dasharray="5,5"/>
                    
                    <!-- Redis â†’ Vehicle Agent -->
                    <path id="arrow-5" class="flow-arrow" d="M 850 360 L 850 420" stroke-dasharray="5,5"/>
                    
                    <!-- Vehicle Agent â†’ SDK -->
                    <path id="arrow-6" class="flow-arrow" d="M 850 500 L 850 560" stroke-dasharray="5,5"/>
                    
                    <!-- SDK â†’ ClickHouse (Telemetry) -->
                    <path id="arrow-7" class="flow-arrow" d="M 750 580 L 400 580 L 400 360" stroke-dasharray="5,5"/>
                </svg>

                <!-- Flow Nodes -->
                <!-- Row 1: Admin Console -->
                <div id="node-admin" class="flow-node absolute bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 20px; left: 150px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-user-shield text-3xl mb-2"></i>
                        <div class="font-bold">Admin Console</div>
                        <div class="text-xs opacity-80">React Dashboard</div>
                    </div>
                </div>

                <!-- Row 2: API Server + Flipt -->
                <div id="node-api" class="flow-node absolute bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 140px; left: 150px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-server text-3xl mb-2"></i>
                        <div class="font-bold">FleetFlag API</div>
                        <div class="text-xs opacity-80">Rust/Axum</div>
                    </div>
                </div>

                <div id="node-flipt" class="flow-node absolute bg-gradient-to-br from-green-500 to-green-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 140px; left: 450px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-cogs text-3xl mb-2"></i>
                        <div class="font-bold">Flipt Engine</div>
                        <div class="text-xs opacity-80">OpenFeature</div>
                    </div>
                </div>

                <!-- Row 3: PostgreSQL + Redis + ClickHouse -->
                <div id="node-postgres" class="flow-node absolute bg-gradient-to-br from-indigo-500 to-indigo-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 280px; left: 450px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-database text-3xl mb-2"></i>
                        <div class="font-bold">PostgreSQL</div>
                        <div class="text-xs opacity-80">Metadata Store</div>
                    </div>
                </div>

                <div id="node-redis" class="flow-node absolute bg-gradient-to-br from-red-500 to-red-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 280px; left: 750px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-bolt text-3xl mb-2"></i>
                        <div class="font-bold">Redis Cluster</div>
                        <div class="text-xs opacity-80">Cache + Pub/Sub</div>
                    </div>
                </div>

                <div id="node-clickhouse" class="flow-node absolute bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 280px; left: 150px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-chart-line text-3xl mb-2"></i>
                        <div class="font-bold">ClickHouse</div>
                        <div class="text-xs opacity-80">Analytics DB</div>
                    </div>
                </div>

                <!-- Row 4: Vehicle Agent -->
                <div id="node-vehicle" class="flow-node absolute bg-gradient-to-br from-teal-500 to-teal-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 420px; left: 750px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-car text-3xl mb-2"></i>
                        <div class="font-bold">Vehicle Agent</div>
                        <div class="text-xs opacity-80">Rust + SQLite</div>
                    </div>
                </div>

                <!-- Row 5: SDK -->
                <div id="node-sdk" class="flow-node absolute bg-gradient-to-br from-pink-500 to-pink-700 text-white rounded-lg shadow-lg p-4" 
                     style="top: 520px; left: 750px; width: 200px; z-index: 10;">
                    <div class="text-center">
                        <i class="fas fa-code text-3xl mb-2"></i>
                        <div class="font-bold">Feature Flag SDK</div>
                        <div class="text-xs opacity-80">C++/Python/Rust</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Timeline -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-tasks mr-2 text-green-600"></i>ì‹¤í–‰ ë‹¨ê³„
            </h2>
            <div class="flex items-center justify-between">
                <div id="step-1" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">1. Admin ìš”ì²­</div>
                    <div class="text-xs">Feature ìƒì„±</div>
                </div>
                <div class="text-gray-400">â†’</div>
                <div id="step-2" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">2. API ê²€ì¦</div>
                    <div class="text-xs">Validation</div>
                </div>
                <div class="text-gray-400">â†’</div>
                <div id="step-3" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">3. DB ì €ì¥</div>
                    <div class="text-xs">PostgreSQL</div>
                </div>
                <div class="text-gray-400">â†’</div>
                <div id="step-4" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">4. ìºì‹œ ê°±ì‹ </div>
                    <div class="text-xs">Redis Pub/Sub</div>
                </div>
                <div class="text-gray-400">â†’</div>
                <div id="step-5" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">5. ì°¨ëŸ‰ ë™ê¸°í™”</div>
                    <div class="text-xs">Delta Sync</div>
                </div>
                <div class="text-gray-400">â†’</div>
                <div id="step-6" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">6. SDK í‰ê°€</div>
                    <div class="text-xs">Local Cache</div>
                </div>
                <div class="text-gray-400">â†’</div>
                <div id="step-7" class="step-indicator flex-1 text-center py-3 rounded-lg mx-1 bg-gray-200">
                    <div class="font-bold">7. ë¶„ì„ ìˆ˜ì§‘</div>
                    <div class="text-xs">ClickHouse</div>
                </div>
            </div>
        </div>

        <!-- Data Flow Details (2 columns) -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            <!-- Left: Real-time Log -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-stream mr-2 text-blue-600"></i>ì‹¤ì‹œê°„ ë¡œê·¸
                </h2>
                <div id="logContainer" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-sm text-center py-8">
                        ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ë©´ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <!-- Right: Data Payload -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-code mr-2 text-purple-600"></i>ë°ì´í„° í˜ì´ë¡œë“œ
                </h2>
                <div id="payloadContainer" class="code-block max-h-96 overflow-y-auto">
                    <pre class="text-sm"><span class="comment">// ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ë©´ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</span></pre>
                </div>
            </div>
        </div>

        <!-- Metrics Dashboard -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-tachometer-alt mr-2 text-green-600"></i>ì„±ëŠ¥ ë©”íŠ¸ë¦­ (ì‹œë®¬ë ˆì´ì…˜)
            </h2>
            <div class="grid grid-cols-4 gap-6">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-3xl font-bold text-blue-600" id="metric-latency">0ms</div>
                    <div class="text-sm text-gray-600 mt-1">í‰ê·  ì§€ì—°ì‹œê°„</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-3xl font-bold text-green-600" id="metric-vehicles">0</div>
                    <div class="text-sm text-gray-600 mt-1">ë™ê¸°í™”ëœ ì°¨ëŸ‰</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-3xl font-bold text-purple-600" id="metric-evaluations">0</div>
                    <div class="text-sm text-gray-600 mt-1">í‰ê°€ íšŸìˆ˜</div>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-3xl font-bold text-orange-600" id="metric-cache">0%</div>
                    <div class="text-sm text-gray-600 mt-1">ìºì‹œ ì ì¤‘ë¥ </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isRunning = false;
        let currentStep = 0;
        let logIndex = 0;

        // DOM elements
        const startBtn = document.getElementById('startSimulation');
        const resetBtn = document.getElementById('resetSimulation');
        const logContainer = document.getElementById('logContainer');
        const payloadContainer = document.getElementById('payloadContainer');

        // Scenario data
        const scenarios = {
            'feature-creation': {
                name: 'Feature ìƒì„± ë° ë°°í¬',
                steps: [
                    {
                        node: 'node-admin',
                        arrow: 'arrow-1',
                        step: 'step-1',
                        title: 'Adminì´ ìƒˆ Feature Flag ìƒì„±',
                        log: '[14:30:22] Admin (ì´ì„±ë£¡ ë¶€ì¥) - POST /api/v1/flags',
                        payload: {
                            key: 'feature-voice-ai-gpt4o',
                            name: 'ìŒì„±ì¸ì‹ AI (GPT-4o)',
                            type: 'boolean',
                            asil_level: 'ASIL-B',
                            default_value: false,
                            rollout_strategy: 'canary',
                            target_percentage: 1
                        },
                        latency: 12,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-api',
                        arrow: 'arrow-2',
                        step: 'step-2',
                        title: 'API Serverê°€ ìš”ì²­ ê²€ì¦',
                        log: '[14:30:23] API Server - Validation passed. ASIL-B requires team lead approval.',
                        payload: {
                            validation: 'success',
                            checks: [
                                { name: 'ASIL level', status: 'OK' },
                                { name: 'BOM dependencies', status: 'OK' },
                                { name: 'Approval required', status: 'PENDING' }
                            ]
                        },
                        latency: 18,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-flipt',
                        arrow: 'arrow-3',
                        step: 'step-3',
                        title: 'Flipt Engineì— Flag ë“±ë¡',
                        log: '[14:30:23] Flipt Engine - Flag registered with OpenFeature spec',
                        payload: {
                            flipt_id: 'flg_xyz789abc',
                            namespace: 'production',
                            evaluation_mode: 'server-side',
                            rules: [
                                { type: 'percentage', value: 1, description: 'Canary 1%' }
                            ]
                        },
                        latency: 24,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-postgres',
                        arrow: 'arrow-4',
                        step: 'step-3',
                        title: 'PostgreSQLì— ë©”íƒ€ë°ì´í„° ì €ì¥',
                        log: '[14:30:24] PostgreSQL - INSERT into flags table (ID: 1234)',
                        payload: {
                            query: 'INSERT INTO flags (key, name, type, asil_level, created_by, created_at) VALUES (...)',
                            affected_rows: 1,
                            transaction_time: '8ms'
                        },
                        latency: 32,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-redis',
                        arrow: 'arrow-5',
                        step: 'step-4',
                        title: 'Redis Pub/Subë¡œ ë³€ê²½ ì•Œë¦¼',
                        log: '[14:30:24] Redis - PUBLISH flag:update:feature-voice-ai-gpt4o',
                        payload: {
                            channel: 'flag:updates',
                            message: {
                                event: 'flag.created',
                                flag_id: 1234,
                                timestamp: '2026-02-01T14:30:24Z'
                            },
                            subscribers: 5243
                        },
                        latency: 35,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 95
                    },
                    {
                        node: 'node-vehicle',
                        arrow: 'arrow-6',
                        step: 'step-5',
                        title: 'ì°¨ëŸ‰ Agentê°€ Delta Sync ìˆ˜í–‰',
                        log: '[14:30:25] Vehicle Agent (VIN: KMHXX00BXPU123456) - Delta sync: 1 new flag',
                        payload: {
                            vin: 'KMHXX00BXPU123456',
                            sync_type: 'delta',
                            flags_updated: 1,
                            local_cache_size: '12.4 MB',
                            sync_duration: '143ms'
                        },
                        latency: 38,
                        vehicles: 1250,
                        evaluations: 0,
                        cache: 97
                    },
                    {
                        node: 'node-sdk',
                        arrow: null,
                        step: 'step-6',
                        title: 'SDKê°€ ë¡œì»¬ ìºì‹œì—ì„œ í‰ê°€',
                        log: '[14:30:26] SDK - evaluate(feature-voice-ai-gpt4o) = false (not in 1% canary)',
                        payload: {
                            flag_key: 'feature-voice-ai-gpt4o',
                            evaluation_result: false,
                            reason: 'percentage_rollout',
                            latency: '2.1ms',
                            cache_hit: true
                        },
                        latency: 2.1,
                        vehicles: 1250,
                        evaluations: 4523,
                        cache: 98
                    },
                    {
                        node: 'node-clickhouse',
                        arrow: 'arrow-7',
                        step: 'step-7',
                        title: 'ClickHouseì— í…”ë ˆë©”íŠ¸ë¦¬ ì €ì¥',
                        log: '[14:30:27] ClickHouse - Batch insert: 4523 evaluation events',
                        payload: {
                            table: 'evaluation_events',
                            rows_inserted: 4523,
                            batch_duration: '54ms',
                            compression_ratio: '12.3x'
                        },
                        latency: 2.1,
                        vehicles: 1250,
                        evaluations: 4523,
                        cache: 98
                    }
                ]
            },
            'kill-switch': {
                name: 'Kill Switch ê¸´ê¸‰ ë°œë™',
                steps: [
                    {
                        node: 'node-admin',
                        arrow: 'arrow-1',
                        step: 'step-1',
                        title: 'Adminì´ Kill Switch ë°œë™',
                        log: '[09:15:33] Admin (ê¹€ì² ìˆ˜ CTO) - POST /api/v1/flags/FLAG-2024-0523/kill-switch/activate',
                        payload: {
                            flag_id: 'FLAG-2024-0523',
                            flag_name: 'ììœ¨ì£¼í–‰ L3 ê³ ì†ë„ë¡œ ëª¨ë“œ',
                            reason: 'Mobileye EyeQ5 ì„¼ì„œ íŒì›¨ì–´ ê²°í•¨ ë°œê²¬. ì°¨ì„  ì¸ì‹ ì˜¤ë¥˜.',
                            scope: 'all_vehicles',
                            approved_by: 'ê¹€ì² ìˆ˜ CTO',
                            two_factor_auth: 'verified'
                        },
                        latency: 8,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-api',
                        arrow: 'arrow-2',
                        step: 'step-2',
                        title: 'API Serverê°€ ì¦‰ì‹œ ì²˜ë¦¬',
                        log: '[09:15:33] API Server - EMERGENCY: Kill Switch activated for FLAG-2024-0523',
                        payload: {
                            priority: 'critical',
                            validation: 'bypassed',
                            approval_chain: 'CTO approved',
                            estimated_impact: '12,847 vehicles'
                        },
                        latency: 12,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-postgres',
                        arrow: 'arrow-4',
                        step: 'step-3',
                        title: 'DBì— Kill Switch ìƒíƒœ ê¸°ë¡',
                        log: '[09:15:34] PostgreSQL - UPDATE flags SET kill_switch_active=true WHERE id=523',
                        payload: {
                            query: 'UPDATE flags SET kill_switch_active=true, kill_switch_reason=...',
                            affected_rows: 1,
                            audit_log_created: true
                        },
                        latency: 15,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-redis',
                        arrow: 'arrow-5',
                        step: 'step-4',
                        title: 'Redis Pub/Sub ê¸´ê¸‰ ë¸Œë¡œë“œìºìŠ¤íŠ¸',
                        log: '[09:15:34] Redis - PUBLISH kill-switch:FLAG-2024-0523 (priority: CRITICAL)',
                        payload: {
                            channel: 'kill-switch',
                            priority: 'CRITICAL',
                            ttl: 0,
                            subscribers: 12847,
                            message: {
                                flag_id: 'FLAG-2024-0523',
                                action: 'disable_immediately'
                            }
                        },
                        latency: 18,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-vehicle',
                        arrow: 'arrow-6',
                        step: 'step-5',
                        title: 'WebSocketìœ¼ë¡œ ì „ ì°¨ëŸ‰ í‘¸ì‹œ',
                        log: '[09:15:35] Vehicle Agents - WebSocket push to 12,847 vehicles',
                        payload: {
                            protocol: 'wss://fleetflag.azure.hyundai.com/ws',
                            vehicles_online: 12800,
                            vehicles_offline: 47,
                            push_duration: '2.8 seconds',
                            ack_received: 12800
                        },
                        latency: 20,
                        vehicles: 12800,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-sdk',
                        arrow: null,
                        step: 'step-6',
                        title: 'SDKê°€ ì¦‰ì‹œ ê°•ì œ ë¹„í™œì„±í™”',
                        log: '[09:15:36] SDK - KILL_SWITCH: FLAG-2024-0523 = false (override local cache)',
                        payload: {
                            flag_key: 'FLAG-2024-0523',
                            previous_value: true,
                            new_value: false,
                            override_reason: 'kill_switch_active',
                            cache_invalidated: true
                        },
                        latency: 0.5,
                        vehicles: 12800,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-clickhouse',
                        arrow: 'arrow-7',
                        step: 'step-7',
                        title: 'Slack ì•Œë¦¼ ë° ê°ì‚¬ ë¡œê·¸',
                        log: '[09:15:37] Notification - Slack alert sent to #safety-critical',
                        payload: {
                            slack_channel: '#safety-critical',
                            alert_level: 'P1',
                            message: 'ğŸ”´ Kill Switch activated: ììœ¨ì£¼í–‰ L3 (12,847 vehicles affected)',
                            audit_log_id: 'audit_20260201_091537',
                            propagation_time: '2h 43m (target: 3h)'
                        },
                        latency: 0.5,
                        vehicles: 12847,
                        evaluations: 0,
                        cache: 0
                    }
                ]
            },
            'ab-test': {
                name: 'A/B í…ŒìŠ¤íŠ¸ ì‹¤í–‰',
                steps: [
                    {
                        node: 'node-admin',
                        arrow: 'arrow-1',
                        step: 'step-1',
                        title: 'Adminì´ A/B í…ŒìŠ¤íŠ¸ ì‹œì‘',
                        log: '[10:00:00] Admin (ë°•ì§€í˜„ ì±…ì„) - POST /api/v1/experiments',
                        payload: {
                            experiment_id: 'exp_20260201_001',
                            name: 'ìŒì„±ì¸ì‹ ì—”ì§„ ë¹„êµ (GPT-4o vs Whisper)',
                            control_flag: 'feature-voice-ai-legacy',
                            variant_a_flag: 'feature-voice-ai-gpt4o',
                            variant_b_flag: 'feature-voice-ai-whisper',
                            traffic_split: { control: 33, variant_a: 33, variant_b: 34 },
                            duration_days: 14
                        },
                        latency: 15,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-api',
                        arrow: 'arrow-2',
                        step: 'step-2',
                        title: 'API Serverê°€ Sticky Session ì„¤ì •',
                        log: '[10:00:01] API Server - Sticky assignment: VIN-based hashing for consistency',
                        payload: {
                            assignment_strategy: 'vin_hash',
                            total_vehicles: 10234,
                            control_group: 3411,
                            variant_a_group: 3411,
                            variant_b_group: 3412
                        },
                        latency: 22,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-postgres',
                        arrow: 'arrow-4',
                        step: 'step-3',
                        title: 'DBì— ì‹¤í—˜ ì„¤ì • ì €ì¥',
                        log: '[10:00:02] PostgreSQL - INSERT into experiments table',
                        payload: {
                            experiment_id: 'exp_20260201_001',
                            status: 'running',
                            start_time: '2026-02-01T10:00:00Z',
                            expected_end: '2026-02-15T10:00:00Z'
                        },
                        latency: 28,
                        vehicles: 0,
                        evaluations: 0,
                        cache: 0
                    },
                    {
                        node: 'node-vehicle',
                        arrow: 'arrow-6',
                        step: 'step-5',
                        title: 'ì°¨ëŸ‰ë³„ ê·¸ë£¹ í• ë‹¹',
                        log: '[10:00:03] Vehicle Agents - Received experiment assignment',
                        payload: {
                            vin: 'KMHXX00BXPU123456',
                            experiment_id: 'exp_20260201_001',
                            assigned_group: 'variant_a',
                            sticky_until: '2026-02-15T10:00:00Z'
                        },
                        latency: 32,
                        vehicles: 10234,
                        evaluations: 0,
                        cache: 97
                    },
                    {
                        node: 'node-sdk',
                        arrow: null,
                        step: 'step-6',
                        title: 'SDKê°€ ê·¸ë£¹ë³„ í‰ê°€ ì‹¤í–‰',
                        log: '[10:00:05] SDK - evaluate() returns variant_a flag value',
                        payload: {
                            experiment_id: 'exp_20260201_001',
                            assigned_group: 'variant_a',
                            flag_evaluated: 'feature-voice-ai-gpt4o',
                            result: true,
                            metadata: { group: 'variant_a', sticky: true }
                        },
                        latency: 2.8,
                        vehicles: 10234,
                        evaluations: 127543,
                        cache: 98
                    },
                    {
                        node: 'node-clickhouse',
                        arrow: 'arrow-7',
                        step: 'step-7',
                        title: 'ClickHouseì— ë©”íŠ¸ë¦­ ìˆ˜ì§‘',
                        log: '[14 days later] ClickHouse - Experiment results analysis complete',
                        payload: {
                            experiment_id: 'exp_20260201_001',
                            duration: '14 days',
                            total_evaluations: 2847231,
                            results: {
                                control: { recognition_rate: 94.2, satisfaction: 3.8 },
                                variant_a: { recognition_rate: 98.7, satisfaction: 4.6 },
                                variant_b: { recognition_rate: 97.1, satisfaction: 4.2 }
                            },
                            statistical_significance: { p_value: 0.001, confidence: 95 },
                            winner: 'variant_a'
                        },
                        latency: 2.8,
                        vehicles: 10234,
                        evaluations: 2847231,
                        cache: 98
                    }
                ]
            }
        };

        // Start simulation
        startBtn.addEventListener('click', async () => {
            if (isRunning) return;
            
            isRunning = true;
            currentStep = 0;
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            const selectedScenario = document.querySelector('input[name="scenario"]:checked').value;
            const scenario = scenarios[selectedScenario];
            
            // Clear previous state
            resetSimulation();
            
            // Run each step
            for (let i = 0; i < scenario.steps.length; i++) {
                const step = scenario.steps[i];
                currentStep = i;
                
                // Activate current node
                activateNode(step.node);
                if (step.arrow) activateArrow(step.arrow);
                activateStep(step.step);
                
                // Add log
                addLog(step.log, 'info');
                
                // Update payload
                updatePayload(step.payload);
                
                // Update metrics
                updateMetrics(step.latency, step.vehicles, step.evaluations, step.cache);
                
                // Wait before next step
                await sleep(2000);
                
                // Deactivate
                deactivateNode(step.node);
                if (step.arrow) deactivateArrow(step.arrow);
                completeStep(step.step);
            }
            
            addLog('âœ… ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!', 'success');
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            isRunning = false;
        });

        // Reset simulation
        resetBtn.addEventListener('click', () => {
            resetSimulation();
        });

        function resetSimulation() {
            currentStep = 0;
            logIndex = 0;
            
            // Clear logs
            logContainer.innerHTML = '<div class="text-gray-500 text-sm text-center py-8">ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ë©´ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
            
            // Clear payload
            payloadContainer.innerHTML = '<pre class="text-sm"><span class="comment">// ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ë©´ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</span></pre>';
            
            // Reset metrics
            document.getElementById('metric-latency').textContent = '0ms';
            document.getElementById('metric-vehicles').textContent = '0';
            document.getElementById('metric-evaluations').textContent = '0';
            document.getElementById('metric-cache').textContent = '0%';
            
            // Reset all nodes
            document.querySelectorAll('.flow-node').forEach(node => {
                node.classList.remove('active');
            });
            
            // Reset all arrows
            document.querySelectorAll('.flow-arrow').forEach(arrow => {
                arrow.classList.remove('active');
            });
            
            // Reset all steps
            document.querySelectorAll('.step-indicator').forEach(step => {
                step.classList.remove('active', 'completed');
            });
        }

        function activateNode(nodeId) {
            const node = document.getElementById(nodeId);
            if (node) {
                node.classList.add('active');
            }
        }

        function deactivateNode(nodeId) {
            const node = document.getElementById(nodeId);
            if (node) {
                setTimeout(() => {
                    node.classList.remove('active');
                }, 500);
            }
        }

        function activateArrow(arrowId) {
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                arrow.classList.add('active');
                arrow.setAttribute('marker-end', 'url(#arrowhead-active)');
            }
        }

        function deactivateArrow(arrowId) {
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                setTimeout(() => {
                    arrow.classList.remove('active');
                    arrow.setAttribute('marker-end', 'url(#arrowhead)');
                }, 500);
            }
        }

        function activateStep(stepId) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.add('active');
            }
        }

        function completeStep(stepId) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.remove('active');
                step.classList.add('completed');
            }
        }

        function addLog(message, type = 'info') {
            if (logIndex === 0) {
                logContainer.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry flex items-start space-x-2 p-2 rounded text-sm';
            
            let icon = 'fa-info-circle';
            let bgColor = 'bg-blue-50';
            let textColor = 'text-blue-800';
            
            if (type === 'success') {
                icon = 'fa-check-circle';
                bgColor = 'bg-green-50';
                textColor = 'text-green-800';
            } else if (type === 'error') {
                icon = 'fa-exclamation-circle';
                bgColor = 'bg-red-50';
                textColor = 'text-red-800';
            }
            
            logEntry.classList.add(bgColor);
            logEntry.innerHTML = `
                <i class="fas ${icon} ${textColor} mt-0.5"></i>
                <div class="${textColor} flex-1">${message}</div>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logIndex++;
        }

        function updatePayload(data) {
            const formatted = JSON.stringify(data, null, 2);
            const highlighted = formatted
                .replace(/"([^"]+)":/g, '<span class="keyword">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span class="string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="highlight">$1</span>')
                .replace(/: (true|false)/g, ': <span class="highlight">$1</span>');
            
            payloadContainer.innerHTML = `<pre class="text-sm">${highlighted}</pre>`;
        }

        function updateMetrics(latency, vehicles, evaluations, cache) {
            document.getElementById('metric-latency').textContent = latency + 'ms';
            document.getElementById('metric-vehicles').textContent = vehicles.toLocaleString();
            document.getElementById('metric-evaluations').textContent = evaluations.toLocaleString();
            document.getElementById('metric-cache').textContent = cache + '%';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
