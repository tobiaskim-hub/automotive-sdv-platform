<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlag - Physical Deployment Viewer (D3.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary: #002c5f;
            --secondary: #00aad2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
        }

        .tab-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .tab-button.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .tab-button:hover:not(.active) {
            background: rgba(0, 170, 210, 0.1);
            border-color: var(--secondary);
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.2);
        }

        .node.selected {
            stroke: #10b981;
            stroke-width: 4px;
        }

        .link {
            stroke: #6b7280;
            stroke-width: 2;
            fill: none;
        }

        .link.active {
            stroke: #10b981;
            stroke-width: 3;
            animation: dash 2s linear infinite;
        }

        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }

        .health-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        #canvas3d {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.5);
        }

        .spec-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .spec-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .spec-value {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .tooltip {
            position: absolute;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(0, 170, 210, 0.5);
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body class="p-6">
    <!-- Header -->
    <div class="glass-panel p-6 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Physical Deployment Viewer (D3.js)</h1>
                    <p class="text-sm text-gray-400">현대자동차 SDV Feature Flag 시스템 물리적 배포 구성도 - Interactive</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm text-gray-400">Total Infrastructure</div>
                    <div class="text-xl font-bold text-white">3 Racks · 12 Servers · 125k Vehicles</div>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <span class="health-indicator" style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="glass-panel p-4 mb-6">
        <div class="flex space-x-4">
            <button class="tab-button active" onclick="switchTab('datacenter')">
                <i class="fas fa-building mr-2"></i>Data Center (Treemap)
            </button>
            <button class="tab-button" onclick="switchTab('vehicle')">
                <i class="fas fa-car mr-2"></i>Vehicle Architecture (Tree)
            </button>
            <button class="tab-button" onclick="switchTab('network')">
                <i class="fas fa-network-wired mr-2"></i>Network Topology (Force)
            </button>
            <button class="tab-button" onclick="switchTab('flow')">
                <i class="fas fa-stream mr-2"></i>System Flow (Sankey)
            </button>
            <button class="tab-button" onclick="switchTab('3d')">
                <i class="fas fa-cube mr-2"></i>3D Rack Viewer
            </button>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Tab Content: Data Center (D3.js Treemap) -->
    <div id="tab-datacenter" class="tab-content">
        <div class="glass-panel p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">
                    <i class="fas fa-building mr-2"></i>IDC Infrastructure - Treemap Visualization
                </h3>
                <div class="flex space-x-2">
                    <button onclick="colorByMetric('cpu')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm">
                        <i class="fas fa-microchip mr-2"></i>CPU 사용률
                    </button>
                    <button onclick="colorByMetric('ram')" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm">
                        <i class="fas fa-memory mr-2"></i>RAM 사용률
                    </button>
                    <button onclick="colorByMetric('power')" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">
                        <i class="fas fa-bolt mr-2"></i>전력 소비량
                    </button>
                </div>
            </div>
            <svg id="datacenterSvg" width="100%" height="600"></svg>
        </div>

        <!-- Server Detail Panel -->
        <div id="server-detail" class="glass-panel p-6 mt-6" style="display: none;">
            <h3 class="text-xl font-bold text-white mb-4">
                <i class="fas fa-server mr-2 text-cyan-400"></i>
                <span id="detail-server-name">Server Details</span>
            </h3>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-400 mb-3">Hardware Specifications</h4>
                    <div id="detail-hardware"></div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-400 mb-3">Current Status</h4>
                    <div id="detail-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Vehicle Architecture (D3.js Tree) -->
    <div id="tab-vehicle" class="tab-content" style="display: none;">
        <div class="glass-panel p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-car mr-2"></i>Vehicle Architecture - Hierarchical Tree
            </h3>
            <svg id="vehicleSvg" width="100%" height="600"></svg>
        </div>

        <!-- Component Detail Panel -->
        <div id="component-detail" class="glass-panel p-6 mt-6" style="display: none;">
            <h3 class="text-xl font-bold text-white mb-4">
                <i class="fas fa-microchip mr-2 text-cyan-400"></i>
                <span id="detail-component-name">Component Details</span>
            </h3>
            <div id="detail-component-content"></div>
        </div>
    </div>

    <!-- Tab Content: Network Topology (D3.js Force-Directed) -->
    <div id="tab-network" class="tab-content" style="display: none;">
        <div class="glass-panel p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">
                    <i class="fas fa-network-wired mr-2"></i>Network Topology - Force-Directed Graph
                </h3>
                <button onclick="simulateDataFlow()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                    <i class="fas fa-play mr-2"></i>데이터 흐름 시뮬레이션
                </button>
            </div>
            <svg id="networkSvg" width="100%" height="600"></svg>
        </div>

        <!-- Network Stats -->
        <div class="grid grid-cols-4 gap-6 mt-6">
            <div class="glass-panel p-4 text-center">
                <div class="text-2xl font-bold text-cyan-400">2.3 Gbps</div>
                <div class="text-xs text-gray-400">Total Throughput</div>
            </div>
            <div class="glass-panel p-4 text-center">
                <div class="text-2xl font-bold text-green-400">8.2 ms</div>
                <div class="text-xs text-gray-400">Avg Latency</div>
            </div>
            <div class="glass-panel p-4 text-center">
                <div class="text-2xl font-bold text-blue-400">125,847</div>
                <div class="text-xs text-gray-400">Active Connections</div>
            </div>
            <div class="glass-panel p-4 text-center">
                <div class="text-2xl font-bold text-purple-400">99.98%</div>
                <div class="text-xs text-gray-400">Uptime</div>
            </div>
        </div>
    </div>

    <!-- Tab Content: System Flow (D3.js Sankey) -->
    <div id="tab-flow" class="tab-content" style="display: none;">
        <div class="glass-panel p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-stream mr-2"></i>System Data Flow - Sankey Diagram
            </h3>
            <svg id="flowSvg" width="100%" height="600"></svg>
        </div>

        <!-- Flow Legend -->
        <div class="glass-panel p-6 mt-6">
            <h4 class="text-lg font-bold text-white mb-4">데이터 흐름량 범례</h4>
            <div class="grid grid-cols-3 gap-4">
                <div class="flex items-center space-x-2">
                    <div style="width: 20px; height: 10px; background: #3b82f6;"></div>
                    <span class="text-sm text-gray-300">API 요청: 1,000 req/s</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div style="width: 20px; height: 10px; background: #8b5cf6;"></div>
                    <span class="text-sm text-gray-300">DB 쓰기: 500 ops/s</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div style="width: 20px; height: 10px; background: #10b981;"></div>
                    <span class="text-sm text-gray-300">차량 푸시: 12,500 msg/s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: 3D Viewer (Three.js) -->
    <div id="tab-3d" class="tab-content" style="display: none;">
        <div class="glass-panel p-6">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-cube mr-2"></i>3D Data Center Rack Viewer
            </h3>
            <div class="mb-4 flex space-x-4">
                <button onclick="rotate3DView('left')" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>Rotate Left
                </button>
                <button onclick="rotate3DView('right')" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-arrow-right mr-2"></i>Rotate Right
                </button>
                <button onclick="reset3DView()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sync-alt mr-2"></i>Reset View
                </button>
            </div>
            <div id="canvas3d"></div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        
        // IDC Server Data (Treemap)
        const idcData = {
            name: "Hyundai IDC",
            children: [
                {
                    name: "Rack 1: Frontend",
                    children: [
                        { name: "LB-01 (Active)", cpu: 23, ram: 41, power: 350, cores: 16, memory: "64GB", storage: "2TB NVMe", type: "Load Balancer" },
                        { name: "LB-02 (Standby)", cpu: 8, ram: 22, power: 180, cores: 16, memory: "64GB", storage: "2TB NVMe", type: "Load Balancer" },
                        { name: "GW-01", cpu: 45, ram: 56, power: 580, cores: 32, memory: "128GB", storage: "4TB NVMe", type: "API Gateway" },
                        { name: "GW-02", cpu: 38, ram: 51, power: 550, cores: 32, memory: "128GB", storage: "4TB NVMe", type: "API Gateway" }
                    ]
                },
                {
                    name: "Rack 2: Backend",
                    children: [
                        { name: "API-01", cpu: 52, ram: 68, power: 780, cores: 64, memory: "256GB", storage: "8TB NVMe", type: "FleetFlag API" },
                        { name: "API-02", cpu: 49, ram: 64, power: 750, cores: 64, memory: "256GB", storage: "8TB NVMe", type: "FleetFlag API" },
                        { name: "FLIPT-01", cpu: 34, ram: 45, power: 480, cores: 32, memory: "128GB", storage: "4TB NVMe", type: "Flipt Engine" },
                        { name: "FLIPT-02", cpu: 31, ram: 42, power: 460, cores: 32, memory: "128GB", storage: "4TB NVMe", type: "Flipt Engine" }
                    ]
                },
                {
                    name: "Rack 3: Data",
                    children: [
                        { name: "PG-01 (Primary)", cpu: 41, ram: 73, power: 820, cores: 64, memory: "512GB", storage: "8TB SSD", type: "PostgreSQL" },
                        { name: "PG-02 (Standby)", cpu: 15, ram: 68, power: 480, cores: 64, memory: "512GB", storage: "8TB SSD", type: "PostgreSQL" },
                        { name: "REDIS-01", cpu: 28, ram: 82, power: 420, cores: 32, memory: "256GB", storage: "4TB NVMe", type: "Redis Cluster" },
                        { name: "CH-01", cpu: 36, ram: 61, power: 680, cores: 64, memory: "512GB", storage: "12TB SSD", type: "ClickHouse" }
                    ]
                }
            ]
        };

        // Vehicle Architecture Data (Tree)
        const vehicleData = {
            name: "Vehicle (Genesis GV80)",
            children: [
                {
                    name: "HPC",
                    description: "High Performance Computer",
                    children: [
                        { name: "FleetFlag Agent", description: "Rust SDK v2.1.0" },
                        { name: "Feature Apps", description: "OTA, Navigation" },
                        { name: "SQLite Cache", description: "7-day retention" }
                    ]
                },
                {
                    name: "CCU",
                    description: "Central Computing Unit",
                    children: [
                        { name: "Sync Agent", description: "gRPC Bidirectional" },
                        { name: "VPN Client", description: "WireGuard" },
                        { name: "CAN Gateway", description: "Dual CAN-FD" }
                    ]
                },
                {
                    name: "ECUs",
                    description: "Electronic Control Units",
                    children: [
                        { name: "ADAS ECU", description: "Renesas R-Car V3H" },
                        { name: "Cluster ECU", description: "TI Jacinto DRA829" },
                        { name: "TCU ECU", description: "Qualcomm SA8155P" }
                    ]
                }
            ]
        };

        // Network Topology Data (Force-Directed)
        const networkNodes = [
            { id: 'internet', label: 'Internet', type: 'cloud', x: 400, y: 50 },
            { id: 'azure', label: 'Azure Front Door', type: 'cdn', x: 400, y: 150 },
            { id: 'firewall', label: 'IDC Firewall', type: 'security', x: 400, y: 250 },
            { id: 'dmz', label: 'DMZ Zone', type: 'zone', x: 200, y: 350 },
            { id: 'app', label: 'App Zone', type: 'zone', x: 400, y: 350 },
            { id: 'data', label: 'Data Zone', type: 'zone', x: 600, y: 350 },
            { id: 'vehicle', label: 'Vehicle CCU', type: 'vehicle', x: 400, y: 500 }
        ];

        const networkLinks = [
            { source: 'internet', target: 'azure', label: 'HTTPS/WSS' },
            { source: 'azure', target: 'firewall', label: 'VPN IPsec' },
            { source: 'firewall', target: 'dmz', label: 'TLS 1.3' },
            { source: 'firewall', target: 'app', label: 'Private' },
            { source: 'firewall', target: 'data', label: 'Private' },
            { source: 'dmz', target: 'vehicle', label: 'LTE/5G' }
        ];

        // System Flow Data (Sankey)
        const flowData = {
            nodes: [
                { name: "Admin Console" },
                { name: "FleetFlag API" },
                { name: "Flipt Engine" },
                { name: "PostgreSQL" },
                { name: "Redis Pub/Sub" },
                { name: "Vehicle Agents\n(125k)" },
                { name: "Feature SDK" },
                { name: "ClickHouse" }
            ],
            links: [
                { source: 0, target: 1, value: 1000 },
                { source: 1, target: 2, value: 1000 },
                { source: 2, target: 3, value: 500 },
                { source: 3, target: 4, value: 800 },
                { source: 4, target: 5, value: 12500 },
                { source: 5, target: 6, value: 12500 },
                { source: 6, target: 7, value: 4500 }
            ]
        };

        // ==================== TAB SWITCHING ====================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById('tab-' + tabName).style.display = 'block';
            event.target.closest('.tab-button').classList.add('active');

            if (tabName === 'datacenter' && !window.treemapInitialized) {
                initDataCenterTreemap();
            } else if (tabName === 'vehicle' && !window.vehicleTreeInitialized) {
                initVehicleTree();
            } else if (tabName === 'network' && !window.networkInitialized) {
                initNetworkTopology();
            } else if (tabName === 'flow' && !window.flowInitialized) {
                initSystemFlow();
            } else if (tabName === '3d' && !window.scene) {
                init3DView();
            }
        }

        // ==================== TAB 1: DATA CENTER TREEMAP ====================
        
        let currentMetric = 'cpu';
        
        function initDataCenterTreemap() {
            const svg = d3.select('#datacenterSvg');
            const width = svg.node().getBoundingClientRect().width;
            const height = 600;

            svg.selectAll('*').remove();

            const g = svg.append('g');

            const treemap = d3.treemap()
                .size([width, height])
                .paddingOuter(3)
                .paddingTop(30)
                .paddingInner(2)
                .round(true);

            const root = d3.hierarchy(idcData)
                .sum(d => d.power || 0)
                .sort((a, b) => b.value - a.value);

            treemap(root);

            const colorScale = d3.scaleLinear()
                .domain([0, 100])
                .range(['#3b82f6', '#ef4444']);

            const cell = g.selectAll('g')
                .data(root.leaves())
                .join('g')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);

            cell.append('rect')
                .attr('width', d => d.x1 - d.x0)
                .attr('height', d => d.y1 - d.y0)
                .attr('fill', d => colorScale(d.data[currentMetric]))
                .attr('stroke', '#1e293b')
                .attr('stroke-width', 2)
                .attr('rx', 6)
                .style('cursor', 'pointer')
                .on('click', (event, d) => showServerDetail(d.data))
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('stroke', '#00aad2').attr('stroke-width', 3);
                    showTooltip(event, d.data);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', '#1e293b').attr('stroke-width', 2);
                    hideTooltip();
                });

            cell.append('text')
                .attr('x', 4)
                .attr('y', 20)
                .attr('fill', 'white')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text(d => d.data.name);

            cell.append('text')
                .attr('x', 4)
                .attr('y', 40)
                .attr('fill', 'rgba(255,255,255,0.8)')
                .attr('font-size', '10px')
                .text(d => `CPU: ${d.data.cpu}% | RAM: ${d.data.ram}% | ${d.data.power}W`);

            // Add rack labels
            const racks = g.selectAll('.rack-label')
                .data(root.children)
                .join('g')
                .attr('class', 'rack-label')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);

            racks.append('rect')
                .attr('width', d => d.x1 - d.x0)
                .attr('height', 25)
                .attr('fill', 'rgba(0, 170, 210, 0.3)')
                .attr('rx', 6);

            racks.append('text')
                .attr('x', 8)
                .attr('y', 17)
                .attr('fill', '#00aad2')
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .text(d => d.data.name);

            window.treemapInitialized = true;
            window.treemapSvg = svg;
            window.treemapRoot = root;
        }

        function colorByMetric(metric) {
            currentMetric = metric;
            const svg = window.treemapSvg;
            const root = window.treemapRoot;

            const colorScale = d3.scaleLinear()
                .domain([0, 100])
                .range(['#3b82f6', '#ef4444']);

            svg.selectAll('rect')
                .filter(d => d && d.data && d.data[metric])
                .transition()
                .duration(500)
                .attr('fill', d => colorScale(d.data[metric]));
        }

        function showServerDetail(data) {
            document.getElementById('detail-server-name').textContent = data.name;
            
            const hardware = `
                <div class="spec-row"><span class="spec-label">Type</span><span class="spec-value">${data.type}</span></div>
                <div class="spec-row"><span class="spec-label">CPU Cores</span><span class="spec-value">${data.cores} Cores</span></div>
                <div class="spec-row"><span class="spec-label">RAM</span><span class="spec-value">${data.memory}</span></div>
                <div class="spec-row"><span class="spec-label">Storage</span><span class="spec-value">${data.storage}</span></div>
            `;
            
            const status = `
                <div class="spec-row"><span class="spec-label">CPU Usage</span><span class="spec-value">${data.cpu}%</span></div>
                <div class="spec-row"><span class="spec-label">RAM Usage</span><span class="spec-value">${data.ram}%</span></div>
                <div class="spec-row"><span class="spec-label">Power Consumption</span><span class="spec-value">${data.power}W</span></div>
            `;
            
            document.getElementById('detail-hardware').innerHTML = hardware;
            document.getElementById('detail-status').innerHTML = status;
            document.getElementById('server-detail').style.display = 'block';
            document.getElementById('server-detail').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ==================== TAB 2: VEHICLE TREE ====================
        
        function initVehicleTree() {
            const svg = d3.select('#vehicleSvg');
            const width = svg.node().getBoundingClientRect().width;
            const height = 600;

            svg.selectAll('*').remove();

            const g = svg.append('g').attr('transform', `translate(${width/2},50)`);

            const tree = d3.tree()
                .size([width - 200, height - 100])
                .separation((a, b) => (a.parent == b.parent ? 1 : 1.2));

            const root = d3.hierarchy(vehicleData);
            tree(root);

            // Links
            g.selectAll('.link')
                .data(root.links())
                .join('path')
                .attr('class', 'link')
                .attr('d', d3.linkVertical()
                    .x(d => d.x - width/2)
                    .y(d => d.y))
                .attr('fill', 'none')
                .attr('stroke', '#6b7280')
                .attr('stroke-width', 2);

            // Nodes
            const node = g.selectAll('.node')
                .data(root.descendants())
                .join('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x - width/2},${d.y})`)
                .style('cursor', 'pointer')
                .on('click', (event, d) => showComponentDetail(d.data));

            node.append('circle')
                .attr('r', d => d.depth === 0 ? 40 : d.depth === 1 ? 30 : 20)
                .attr('fill', d => {
                    if (d.depth === 0) return '#3b82f6';
                    if (d.depth === 1) return '#8b5cf6';
                    return '#10b981';
                })
                .attr('stroke', '#00aad2')
                .attr('stroke-width', 2)
                .on('mouseover', function() {
                    d3.select(this).transition().duration(200)
                        .attr('r', d => (d.depth === 0 ? 40 : d.depth === 1 ? 30 : 20) + 5)
                        .attr('stroke-width', 4);
                })
                .on('mouseout', function() {
                    d3.select(this).transition().duration(200)
                        .attr('r', d => d.depth === 0 ? 40 : d.depth === 1 ? 30 : 20)
                        .attr('stroke-width', 2);
                });

            node.append('text')
                .attr('dy', d => d.depth === 0 ? 5 : 5)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .attr('font-size', d => d.depth === 0 ? '14px' : d.depth === 1 ? '12px' : '10px')
                .attr('font-weight', 'bold')
                .text(d => d.data.name);

            window.vehicleTreeInitialized = true;
        }

        function showComponentDetail(data) {
            document.getElementById('detail-component-name').textContent = data.name;
            
            let content = `<div class="text-sm text-gray-400 mb-4">${data.description || ''}</div>`;
            
            if (data.children) {
                content += '<h4 class="text-sm font-semibold text-gray-400 mb-3">Sub-components</h4><ul class="space-y-2">';
                data.children.forEach(child => {
                    content += `<li class="text-sm text-gray-300"><i class="fas fa-microchip text-cyan-400 mr-2"></i>${child.name}: ${child.description || ''}</li>`;
                });
                content += '</ul>';
            }
            
            document.getElementById('detail-component-content').innerHTML = content;
            document.getElementById('component-detail').style.display = 'block';
            document.getElementById('component-detail').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ==================== TAB 3: NETWORK TOPOLOGY ====================
        
        function initNetworkTopology() {
            const svg = d3.select('#networkSvg');
            const width = svg.node().getBoundingClientRect().width;
            const height = 600;

            svg.selectAll('*').remove();

            const g = svg.append('g');

            const simulation = d3.forceSimulation(networkNodes)
                .force('link', d3.forceLink(networkLinks).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-1000))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(80));

            // Links
            const link = g.append('g')
                .selectAll('line')
                .data(networkLinks)
                .join('line')
                .attr('class', 'link')
                .attr('stroke', '#6b7280')
                .attr('stroke-width', 3);

            // Link labels
            const linkLabel = g.append('g')
                .selectAll('text')
                .data(networkLinks)
                .join('text')
                .attr('fill', '#94a3b8')
                .attr('font-size', '10px')
                .attr('text-anchor', 'middle')
                .text(d => d.label);

            // Nodes
            const node = g.append('g')
                .selectAll('g')
                .data(networkNodes)
                .join('g')
                .attr('class', 'node')
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', 50)
                .attr('fill', d => {
                    const colors = {
                        cloud: '#64748b',
                        cdn: '#3b82f6',
                        security: '#ef4444',
                        zone: '#10b981',
                        vehicle: '#f59e0b'
                    };
                    return colors[d.type] || '#6b7280';
                })
                .attr('stroke', '#00aad2')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('stroke-width', 4);
                    showTooltip(event, d);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke-width', 2);
                    hideTooltip();
                });

            node.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', 5)
                .attr('fill', 'white')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text(d => d.label.split(' ')[0])
                .each(function(d) {
                    const text = d3.select(this);
                    const words = d.label.split(' ');
                    if (words.length > 1) {
                        text.append('tspan')
                            .attr('x', 0)
                            .attr('dy', '1.2em')
                            .text(words.slice(1).join(' '));
                    }
                });

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            window.networkInitialized = true;
            window.networkSimulation = simulation;
        }

        function simulateDataFlow() {
            const svg = d3.select('#networkSvg');
            const links = svg.selectAll('.link');

            links.transition()
                .duration(500)
                .attr('stroke', '#10b981')
                .attr('stroke-width', 5)
                .transition()
                .duration(500)
                .attr('stroke', '#6b7280')
                .attr('stroke-width', 3);
        }

        // ==================== TAB 4: SYSTEM FLOW SANKEY ====================
        
        function initSystemFlow() {
            const svg = d3.select('#flowSvg');
            const width = svg.node().getBoundingClientRect().width;
            const height = 600;

            svg.selectAll('*').remove();

            const sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(40)
                .extent([[1, 5], [width - 1, height - 5]]);

            const {nodes, links} = sankey({
                nodes: flowData.nodes.map(d => Object.assign({}, d)),
                links: flowData.links.map(d => Object.assign({}, d))
            });

            const colorScale = d3.scaleOrdinal()
                .domain(d3.range(0, 8))
                .range(['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#84cc16']);

            // Links
            svg.append('g')
                .selectAll('path')
                .data(links)
                .join('path')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', (d, i) => colorScale(i))
                .attr('stroke-width', d => Math.max(1, d.width))
                .attr('fill', 'none')
                .attr('opacity', 0.5)
                .on('mouseover', function() {
                    d3.select(this).attr('opacity', 0.8);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 0.5);
                });

            // Nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g');

            node.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', (d, i) => colorScale(i))
                .attr('stroke', '#000')
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function() {
                    d3.select(this).attr('stroke', '#00aad2').attr('stroke-width', 3);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', '#000').attr('stroke-width', 1);
                });

            node.append('text')
                .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr('y', d => (d.y1 + d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
                .attr('fill', 'white')
                .attr('font-size', '12px')
                .text(d => d.name);

            window.flowInitialized = true;
        }

        // ==================== TAB 5: 3D VIEWER ====================
        
        let scene, camera, renderer, controls;
        let rackMeshes = [];

        function init3DView() {
            const container = document.getElementById('canvas3d');
            const width = container.clientWidth;
            const height = 600;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);
            scene.fog = new THREE.Fog(0x0f172a, 10, 50);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(15, 10, 15);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const gridHelper = new THREE.GridHelper(40, 40, 0x00aad2, 0x1e293b);
            scene.add(gridHelper);

            createRack(-8, 0, 0, 0x3b82f6, 'Rack 1: Frontend');
            createRack(0, 0, 0, 0x8b5cf6, 'Rack 2: Backend');
            createRack(8, 0, 0, 0x10b981, 'Rack 3: Data');

            animate();
        }

        function createRack(x, y, z, color, label) {
            const frameGeometry = new THREE.BoxGeometry(2, 8, 1);
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0x1e293b,
                transparent: true,
                opacity: 0.8
            });
            const frame = new THREE.Mesh(frameGeometry, frameMaterial);
            frame.position.set(x, 4, z);
            frame.castShadow = true;
            scene.add(frame);

            for (let i = 0; i < 4; i++) {
                const serverGeometry = new THREE.BoxGeometry(1.8, 1.5, 0.8);
                const serverMaterial = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.2
                });
                const server = new THREE.Mesh(serverGeometry, serverMaterial);
                server.position.set(x, 1.5 + i * 2, z);
                server.castShadow = true;
                scene.add(server);
                rackMeshes.push(server);

                const ledGeometry = new THREE.SphereGeometry(0.05, 16, 16);
                const ledMaterial = new THREE.MeshBasicMaterial({
                    color: 0x10b981,
                    emissive: 0x10b981
                });
                const led = new THREE.Mesh(ledGeometry, ledMaterial);
                led.position.set(x - 0.8, 1.5 + i * 2, z + 0.4);
                scene.add(led);
            }

            createTextLabel(label, x, 8.5, z);
        }

        function createTextLabel(text, x, y, z) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 128;
            context.fillStyle = 'rgba(0, 170, 210, 0.8)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.font = 'Bold 48px Arial';
            context.fillStyle = 'white';
            context.textAlign = 'center';
            context.fillText(text, 256, 80);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.position.set(x, y, z);
            sprite.scale.set(4, 1, 1);
            scene.add(sprite);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            rackMeshes.forEach((mesh, index) => {
                const time = Date.now() * 0.001;
                mesh.material.emissiveIntensity = 0.2 + Math.sin(time + index * 0.5) * 0.1;
            });

            renderer.render(scene, camera);
        }

        function rotate3DView(direction) {
            if (!camera) return;
            const angle = direction === 'left' ? 0.2 : -0.2;
            const x = camera.position.x;
            const z = camera.position.z;
            camera.position.x = x * Math.cos(angle) - z * Math.sin(angle);
            camera.position.z = x * Math.sin(angle) + z * Math.cos(angle);
            camera.lookAt(0, 4, 0);
        }

        function reset3DView() {
            if (!camera) return;
            camera.position.set(15, 10, 15);
            camera.lookAt(0, 4, 0);
            controls.reset();
        }

        // ==================== TOOLTIP ====================
        
        function showTooltip(event, data) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="font-bold text-cyan-400 mb-2">${data.label || data.name}</div>
                <div class="text-sm text-gray-300">
                    ${data.type ? `Type: ${data.type}<br>` : ''}
                    ${data.cpu ? `CPU: ${data.cpu}%<br>` : ''}
                    ${data.ram ? `RAM: ${data.ram}%<br>` : ''}
                    ${data.power ? `Power: ${data.power}W` : ''}
                </div>
            `;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        // ==================== INITIALIZATION ====================
        
        window.addEventListener('load', () => {
            initDataCenterTreemap();
        });

        window.addEventListener('resize', () => {
            if (renderer && camera) {
                const container = document.getElementById('canvas3d');
                const width = container.clientWidth;
                const height = 600;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        });
    </script>
</body>
</html>
