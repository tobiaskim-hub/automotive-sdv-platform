<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlag - DevOps Toolchain Management (JointJS Layouts)</title>
    
    <!-- JointJS CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.0/joint.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #00aad2 100%);
            border-color: #3b82f6;
            color: white;
        }

        .paper-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            min-height: 700px;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
        }

        .stat-label {
            font-size: 14px;
            color: #94a3b8;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="p-8">
    <!-- Header -->
    <div class="max-w-[1400px] mx-auto mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">
                    <i class="fas fa-project-diagram mr-3" style="color: #00aad2;"></i>
                    DevOps Toolchain Management
                </h1>
                <p class="text-slate-400">Professional Visualization with JointJS Automatic Layouts</p>
            </div>
            <div class="flex gap-3">
                <button onclick="relayout()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
                    <i class="fas fa-sync mr-2"></i>Re-Layout
                </button>
                <button onclick="exportSVG()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition">
                    <i class="fas fa-file-image mr-2"></i>Export SVG
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="stat-value">8</div>
                <div class="stat-label">DevOps Stages</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">27</div>
                <div class="stat-label">Active Tools</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">2.5 min</div>
                <div class="stat-label">Cycle Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">98.5%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-[1400px] mx-auto">
        <!-- Tabs -->
        <div class="flex gap-3 mb-6">
            <button class="tab-button active" onclick="switchTab('circular')">
                <i class="fas fa-circle-notch mr-2"></i>Circular Layout
            </button>
            <button class="tab-button" onclick="switchTab('directed')">
                <i class="fas fa-project-diagram mr-2"></i>Directed Graph
            </button>
            <button class="tab-button" onclick="switchTab('grid')">
                <i class="fas fa-th mr-2"></i>Grid Layout
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="glass-card p-6">
            <!-- Tab 1: Circular Layout -->
            <div id="tab-circular" class="tab-content">
                <h2 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-circle-notch mr-2 text-purple-400"></i>
                    DevOps Circular Layout
                </h2>
                <div class="paper-container relative">
                    <div class="control-panel">
                        <button class="control-btn" onclick="fitContent('circular')" title="Fit to View">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div id="paper-circular"></div>
                </div>
            </div>

            <!-- Tab 2: Directed Graph -->
            <div id="tab-directed" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-project-diagram mr-2 text-blue-400"></i>
                    DevOps Directed Graph (Dagre Layout)
                </h2>
                <div class="paper-container relative">
                    <div class="control-panel">
                        <button class="control-btn" onclick="fitContent('directed')" title="Fit to View">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div id="paper-directed"></div>
                </div>
            </div>

            <!-- Tab 3: Grid Layout -->
            <div id="tab-grid" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-th mr-2 text-indigo-400"></i>
                    DevOps Grid Layout
                </h2>
                <div class="paper-container relative">
                    <div class="control-panel">
                        <button class="control-btn" onclick="fitContent('grid')" title="Fit to View">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div id="paper-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JointJS Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.6.0/backbone-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.0/joint.min.js"></script>
    
    <!-- Dagre for DirectedGraph Layout -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/graphlib@2.1.8/dist/graphlib.core.min.js"></script>

    <script>
        // DevOps Stage Data
        const stages = [
            { id: 'plan', name: 'Plan', color: '#7e57c2' },
            { id: 'code', name: 'Code', color: '#26a69a' },
            { id: 'build', name: 'Build', color: '#42a5f5' },
            { id: 'test', name: 'Test', color: '#66bb6a' },
            { id: 'release', name: 'Release', color: '#ffa726' },
            { id: 'deploy', name: 'Deploy', color: '#ef5350' },
            { id: 'operate', name: 'Operate', color: '#ab47bc' },
            { id: 'monitor', name: 'Monitor', color: '#29b6f6' }
        ];

        // Connections (DevOps cycle)
        const connections = [
            ['plan', 'code'],
            ['code', 'build'],
            ['build', 'test'],
            ['test', 'release'],
            ['release', 'deploy'],
            ['deploy', 'operate'],
            ['operate', 'monitor'],
            ['monitor', 'plan'] // Loop back
        ];

        // Global objects
        let graphs = {};
        let papers = {};
        let elements = {};

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCircularLayout();
            initDirectedGraph();
            initGridLayout();
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            event.target.classList.add('active');
        }

        // Create element helper
        function createElement(stage) {
            return new joint.shapes.standard.Rectangle({
                id: stage.id,
                size: { width: 120, height: 80 },
                attrs: {
                    body: {
                        fill: stage.color,
                        stroke: '#ffffff',
                        strokeWidth: 3,
                        rx: 12,
                        ry: 12,
                        filter: { name: 'dropShadow', args: { dx: 0, dy: 3, blur: 8, color: 'rgba(0,0,0,0.3)' } }
                    },
                    label: {
                        text: stage.name,
                        fill: '#ffffff',
                        fontSize: 14,
                        fontWeight: 'bold',
                        textAnchor: 'middle',
                        textVerticalAnchor: 'middle'
                    }
                }
            });
        }

        // Create link helper
        function createLink(sourceId, targetId) {
            return new joint.shapes.standard.Link({
                source: { id: sourceId },
                target: { id: targetId },
                attrs: {
                    line: {
                        stroke: '#3b82f6',
                        strokeWidth: 3,
                        targetMarker: {
                            type: 'path',
                            d: 'M 10 -5 L 0 0 L 10 5 Z',
                            fill: '#3b82f6'
                        }
                    }
                },
                connector: { name: 'rounded' },
                router: { name: 'normal' }
            });
        }

        // ==========================================
        // TAB 1: CIRCULAR LAYOUT
        // ==========================================
        function initCircularLayout() {
            const graph = new joint.dia.Graph();
            graphs['circular'] = graph;

            const paper = new joint.dia.Paper({
                el: document.getElementById('paper-circular'),
                model: graph,
                width: 1300,
                height: 650,
                gridSize: 10,
                background: { color: '#ffffff' },
                interactive: false
            });
            papers['circular'] = paper;

            // Create elements
            const els = {};
            stages.forEach(stage => {
                const el = createElement(stage);
                el.addTo(graph);
                els[stage.id] = el;
            });
            elements['circular'] = els;

            // Create links
            connections.forEach(([src, tgt]) => {
                createLink(src, tgt).addTo(graph);
            });

            // Apply circular layout
            applyCircularLayout(graph);
        }

        function applyCircularLayout(graph) {
            const cells = graph.getCells();
            const elements = cells.filter(c => c.isElement());
            const n = elements.length;
            const cx = 650, cy = 325, r = 200;

            elements.forEach((el, i) => {
                const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
                const x = cx + r * Math.cos(angle) - 60;
                const y = cy + r * Math.sin(angle) - 40;
                el.position(x, y);
            });
        }

        // ==========================================
        // TAB 2: DIRECTED GRAPH (DAGRE)
        // ==========================================
        function initDirectedGraph() {
            const graph = new joint.dia.Graph();
            graphs['directed'] = graph;

            const paper = new joint.dia.Paper({
                el: document.getElementById('paper-directed'),
                model: graph,
                width: 1300,
                height: 650,
                gridSize: 10,
                background: { color: '#ffffff' },
                interactive: false
            });
            papers['directed'] = paper;

            // Create elements
            const els = {};
            stages.forEach(stage => {
                const el = createElement(stage);
                el.addTo(graph);
                els[stage.id] = el;
            });
            elements['directed'] = els;

            // Create links (without loop-back for better dagre layout)
            connections.slice(0, 7).forEach(([src, tgt]) => {
                createLink(src, tgt).addTo(graph);
            });
            // Add loop-back as curved link
            const loopLink = createLink('monitor', 'plan');
            loopLink.attr('line/strokeDasharray', '8,4');
            loopLink.attr('line/stroke', '#8b5cf6');
            loopLink.vertices([
                { x: 650, y: 600 }
            ]);
            loopLink.addTo(graph);

            // Apply Dagre layout
            if (typeof dagre !== 'undefined') {
                applyDagreLayout(graph);
            } else {
                console.warn('Dagre not loaded, using manual layout');
                applyManualDirectedLayout(graph);
            }
        }

        function applyDagreLayout(graph) {
            try {
                // Create dagre graph
                const g = new dagre.graphlib.Graph();
                g.setGraph({ 
                    rankdir: 'LR',
                    nodesep: 80,
                    ranksep: 150
                });
                g.setDefaultEdgeLabel(() => ({}));

                // Add nodes
                graph.getElements().forEach(el => {
                    g.setNode(el.id, {
                        width: el.size().width,
                        height: el.size().height
                    });
                });

                // Add edges
                graph.getLinks().forEach(link => {
                    const src = link.source();
                    const tgt = link.target();
                    if (src.id && tgt.id) {
                        g.setEdge(src.id, tgt.id);
                    }
                });

                // Run layout
                dagre.layout(g);

                // Apply positions
                graph.getElements().forEach(el => {
                    const node = g.node(el.id);
                    if (node) {
                        el.position(node.x - node.width/2, node.y - node.height/2);
                    }
                });
            } catch (e) {
                console.error('Dagre layout error:', e);
                applyManualDirectedLayout(graph);
            }
        }

        function applyManualDirectedLayout(graph) {
            const elements = graph.getElements();
            const startX = 100, startY = 280, spacing = 150;
            
            elements.forEach((el, i) => {
                el.position(startX + i * spacing, startY);
            });
        }

        // ==========================================
        // TAB 3: GRID LAYOUT
        // ==========================================
        function initGridLayout() {
            const graph = new joint.dia.Graph();
            graphs['grid'] = graph;

            const paper = new joint.dia.Paper({
                el: document.getElementById('paper-grid'),
                model: graph,
                width: 1300,
                height: 650,
                gridSize: 10,
                background: { color: '#ffffff' },
                interactive: false
            });
            papers['grid'] = paper;

            // Create elements
            const els = {};
            stages.forEach(stage => {
                const el = createElement(stage);
                el.addTo(graph);
                els[stage.id] = el;
            });
            elements['grid'] = els;

            // Create links
            connections.forEach(([src, tgt]) => {
                createLink(src, tgt).addTo(graph);
            });

            // Apply grid layout
            applyGridLayout(graph);
        }

        function applyGridLayout(graph) {
            const elements = graph.getElements();
            const cols = 4, rows = 2;
            const startX = 150, startY = 180;
            const spacingX = 250, spacingY = 200;

            elements.forEach((el, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = startX + col * spacingX;
                const y = startY + row * spacingY;
                el.position(x, y);
            });
        }

        // ==========================================
        // CONTROLS
        // ==========================================
        function fitContent(view) {
            const paper = papers[view];
            if (paper) {
                paper.scaleContentToFit({ padding: 40 });
            }
        }

        function relayout() {
            const activeView = document.querySelector('.tab-content:not([style*="display: none"])').id.replace('tab-', '');
            const graph = graphs[activeView];
            
            if (activeView === 'circular') {
                applyCircularLayout(graph);
            } else if (activeView === 'directed') {
                if (typeof dagre !== 'undefined') {
                    applyDagreLayout(graph);
                } else {
                    applyManualDirectedLayout(graph);
                }
            } else if (activeView === 'grid') {
                applyGridLayout(graph);
            }
        }

        function exportSVG() {
            const activeView = document.querySelector('.tab-content:not([style*="display: none"])').id.replace('tab-', '');
            const paper = papers[activeView];
            
            if (paper) {
                const svg = paper.svg;
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svg);
                
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `devops-${activeView}-layout.svg`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>
